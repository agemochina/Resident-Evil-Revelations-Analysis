# ResidentEvil:Revelations 生化危机启示录 GSC(混沌鬼船) 武器掉落分析

分析的依据
- IDA 工具对游戏代码反汇编GDB调试
- ROM 文件数据解析

PS：从反汇编代码看到几处命名叫这个： gacha（ガチャ/抽卡），看上去Capcom把这事定位的很清楚


# 结论

太长不看版：先说结论。后文是详细分析报告。

- 武器掉落判定在结算界面，即初始化和拾取都不进行判定，只有结算的时候逐个开奖。
- 武器掉落为随机，和各种玄学因素无关（时间、杀敌数、受伤、全灭还是速刷、A还是B、9武器还是7武器、人物名字、人物颜色、已有物品、之前出货记录...），上述数值，在代码中不参与掉落计算。
- 寻宝插件(Rare Finders/人品插件)影响：对蓝底率、满孔率产生巨大的影响，寻宝插件可叠加、不区分顺序。
- 寻宝插件不影响：武器类型判定、异名判定。这两个是纯随机和装备无关。
- 想出货，正确思路是尽可能多带寻宝插件，拼箱子数，肝起来，弄其他玄学没用。箱子开的越多才能开出更多好东西。

常见概率（开1个箱子）
- 带9寻宝，蓝底 = 16.4%
- 带8寻宝，蓝底 = 15.5%
- 带7寻宝，蓝底 = 14.6%
- 带9寻宝，蓝底+异名 = 16.4% * 1.5% ≈ 0.246% 约千分之2.5
- 带9寻宝，蓝底+异名+满孔 = 16.4% * 1.5% * 40%  ≈ 0.1% 约千分之1
- 带9寻宝，蓝底+异名+满孔+各种麦林 = 16.4% * 1.5% * 40% * (5%+4%+1.5%) ≈ 0.01% 约万分之1

换句话说：
- 寻宝插件去掉一两个最小的+区别不明显，但尽量不要去掉 +++ ++ 高级寻宝插件，有条件尽量多带
- 带7、8、9个寻宝插件
    - 跑7武器平均每局蓝底1.1个，跑9武器平均每局蓝底1.4个（不是说必出，是指大数据统计）
    - 平均1000箱子出1个蓝底满孔异名
    - 平均10000箱子出1个蓝底满孔异名麦林（魔蛇/雷霆之鹰/死神其中之一）

# 掉落判定步骤

武器掉落分四步：WeaponID -> WeaponLevel -> Slots -> TAG
- WeaponID: 先判定掉落哪种武器，注意：异名(RareTag)是标签不是武器类型。
- WeaponLevel: 判定武器等级（Lv48, Lv49, Lv50, Lv51=SP=蓝底)
- Slots: 判定孔数
- TAG：武器标签（无标签;各种标签;异名也是标签）

# 掉落判定第一步：Weapon ID

先决定掉落哪种武器。注意：异名是一个武器标签(TAG)，不是新的武器ID。

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_id = choose_weapon(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后从上到下查表获得武器ID。
武器表在ROM文件：archive\game\coop_table\weaponRate.lvt 中，原始内容为：

|Weapon Name| Weapon ID  | Rate% |
|------|------------|------|
|M92F| 0x80051000 | 8.0  |
|Government| 0x80051010 | 7.5  |
|G18| 0x80051040 | 2.0  |
|PC365| 0x80051060 | 7.0  |
|Python| 0x80051100 | 5.0  |
|L.Hawk| 0x80051110 | 3.0  |
|Pale Rider| 0x80051120 | 1.5  |
|MP5| 0x80051200 | 7.5  |
|P-90| 0x80051210 | 6.0  |
|AUG| 0x80051220 | 7.0  |
|G36| 0x80051230 | 7.5  |
|High Roller| 0x80051250 | 2.0  |
|Windham| 0x80051300 | 8.0  |
|M3| 0x80051310 | 7.5  |
|Hydra| 0x80051320 | 2.0  |
|Drake| 0x80051330 | 1.5  |
|M40A1| 0x80051400 | 8.0  |
|PSG1| 0x80051410 | 7.5  |
|Muramasa| 0x80051420 | 1.5  |

以上表格中几率加在一起是100%，查表就是看分数落在那个区间中。举例：
- Score=1.0 查表判定 0x80051000 M92F
- Score=25.0 查表判定 0x80051100 Python
- Score=30.0 查表判定 0x80051110 L.Hawk
- Score=99.0 查表判定 0x80051420 村正

唯一的变数就是随机值 score 分数，即只要确定了 Score 值，那么就确定了武器ID，没有任何其他影响因素。

# 掉落判定第二步，Weapon Level

Weapon Level 判定武器等级（Lv48, Lv49, Lv50, Lv51=SP=蓝底)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_level(score, rate_finders)
```

解释：意思是先打分 -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后计算武器等级。
原始数据表在ROM文件archive\game\coop_table\weaponRarityRate.lvt

| Weapon Level | Rate   |
|-------|--------|
| +0    | 0.8221 |
| +1    | 0.1084 |
| +2    | 0.0546 |
| +3    | 0.0149 |

weapon_level指相对于基数的额外增加等级 [+0 ~ +3]，混沌鬼船(GSC)武器基数Lv48, 因此混沌武器掉落Lv48~Lv51，其中Lv51=蓝底(SP)，从表格上看Lv51需要+3几率只有 0.0149(1.49%)，实际游戏SP蓝底概率没这么低，这是因为你装了寻宝插件(Rare Finders/人品插件)，它会对蓝底概率产生巨大的影响。

RareFinders 分为三种： + ++ +++ ，可叠加，不区分顺序，每种分别增加1、2、3点数。例如三把武器装满寻宝，那么寻宝值=(1+2+3)*3=18点。

每1点寻宝值可以增加Lv51掉率约1%（准确值为0.83%）

所以每个箱子开出Lv51=SP蓝底几率为：
- 9RF，SP率 = 1.49%(基数) + 18*0.83 ≈ 16.4%
- 8RF，SP率 = 1.49%(基数) + 17*0.83 ≈ 15.5%
- 7RF，SP率 = 1.49%(基数) + 16*0.83 ≈ 14.6%
- 3RF(+++ +++ +++)，SP率 = 1.49%(基数) + 9*0.83 ≈ 8.8%
- 0RF，SP率 = 1.49%

（注意，上面8、7都是指拿掉最小的那个+，影响不太大）

# 掉落判定第三步、SLOT

SLOT即孔数。

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_slots(score, weapon_id, weapon_level, rate_finders)
```

解释：意思是先打分 -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后根据武器ID、是否蓝底、寻宝插件计算槽数。
蓝底必+1孔，实际孔数 = 1 + 武器基础孔数 + 孔随机调整(-2 ~ +2)

基础槽数表在ROM文件archive\game\coop_table\weaponSlotRate.lvt 的最后一行
| -2   | -1   | +0   | +1   | +2   |
|------|------|------|------|------|
| 0.09 | 0.22 | 0.41 | 0.14 | 0.14 |

上述是基础孔率，寻宝插件会显著影响满孔概率。

游戏过程：先打分，看落到哪个区间，分数太低会进入 -2、-1 这个区间，意思是比标准的还要少孔

下表为蓝底Python满孔分值表，意思是随机数多少分以上，才能是满孔6孔

| 寻宝数| 分数| 备注      |
|------|-----| -------- | 
| 9    | 53.6| 装满各种寻宝 |
| 8    | todo| 去掉1个 寻宝+ |
| 7    | todo| 去掉2个 寻宝+ |
| 3    | todo| 只留三个 寻宝+++ |
| 0    | todo| |

| 9寻宝score | Python孔 |
|------|---|
| 0.0  | 2 |
| 20.0 | 4 |
| 45.0 | 5 |
| 53.5 | 5 |
| 53.6 | 6 |
| 55.0 | 6 |
| 75.0 | 6 |
| 99.9 | 6 |

即：9寻宝随机数在 53.6 分之上，出来的Python就是满孔的，即 Python满孔率 = 100-53.6 = 46.4%


| 3寻宝score | Python孔 |
|---|---|
| 65.0 | 5 |
| 70.0 | 6 |

即3寻宝（+++ +++ +++），要大约70分以上Python才是满孔的，从这看寻宝对满孔率影响很大

TODO：补充7寻宝、0寻宝数据。

# 掉落判定第四步、TAG 标签

最后一步判定标签。注意：异名是一个武器标签(TAG)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int tag = choose_tag(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得武器标签。只要这个数字确定，武器标签就确定。
标签表在ROM文件：archive\game\coop_table\weaponTagRate.lvt 中，原始内容为：

| 英文名         | 中文名      | TAG Id     | Rate% |
| :------------- | :---------- | :--------- | :---- |
| No TAG         | 无标签      | 0          | 50.0  |
| Short Range    | 短射程      | 0x80090000 | 5.0   |
| Long Range     | 长射程      | 0x80090001 | 5.0   |
| Easy Grip      | 轻松握力    | 0x80090002 | 5.0   |
| Speed Shot     | 高速射击    | 0x80090003 | 5.0   |
| Steady Hand    | 稳定之手    | 0x80090004 | 5.0   |
| Speed Load     | 高速装填    | 0x80090005 | 5.0   |
| Sonic Assist   | 音速助攻    | 0x80090006 | 5.0   |
| Light Weight   | 轻盈        | 0x80090007 | 6.0   |
| Sonic Assist+  | 音速助攻+   | 0x80090008 | 2.5   |
| Short Range+   | 短射程+     | 0x80090009 | 2.5   |
| Long Range+    | 长射程+     | 0x8009000A | 2.5   |
| Rare           | 异名        | 0x8009000B | 1.5   |

举几个score值例子：
- 1.0 无标签
- 49.9  无标签
- 50.0 0x80090000 短射程
- 90.0 0x80090007 轻盈
- 98.4 0x8009000A 长射程+
- 98.5 0x8009000B 异名（Rare）
- 99.0 0x8009000B 异名（Rare）
- 99.9 0x8009000B 异名（Rare）

解释：无标签为 50%，异名（Rare）为1.5%，只有随机分超过98.5分才是异名
