# ResidentEvil:Revelations 生化危机启示录 GSC(混沌鬼船) 武器掉落机制研究

*本研究严格遵循非商业、教育之目的，内容仅涉及技术交流与游戏机制的学术探讨。*

分析的依据
- IDA 工具对游戏代码反汇编GDB调试
- ROM 文件数据解析
- Switch模拟器+游戏版本v1.01

PS：从反汇编代码看到几处命名叫这个： gacha（ガチャ/抽卡），意思很明确了。

# 结论

太长不看版：先把结论放前面。

- 想出货，应该**尽可能多带寻宝插件，拼箱子数**，肝起来。
- **没有玄学**: 掉落判定只与随机和寻宝插件有关。和各种玄学因素值无关（时间、杀敌数、受伤、全灭还是速刷、A还是B、9武器还是7武器、人物名字、人物颜色、已有物品、之前出货记录...），上述数值在游戏代码中不参与计算。
- 武器掉落判定在结算界面，即游戏初始化和拾取都不判定，只有结算的时候逐个抽卡。
- 寻宝插件(RareFinders)：极大的提升**蓝底率**、**满孔率**。寻宝插件可叠加、不区分顺序。
- 寻宝插件不影响：武器类型判定、异名判定，这两个纯随机，不依赖寻宝。
- 带7或8或9个寻宝插件（以下概率，指大数据统计意义的，不代表个别欧皇案例）
    - 平均 跑7武器每局蓝底1.1个，跑9武器每局蓝底1.4个
    - 平均 **1000箱子** 出1个**蓝底满孔异名**
    - 平均 **10000箱子** 出1个**蓝底满孔异名麦林**（魔蛇/雷霆之鹰/死神其中之一）


详细概率表（开1个箱子）
| RareFinder寻宝 | Lv51(蓝底) | MaxSlot(满孔) | Rare(异名) | 蓝底满孔异名 |
| :------------- | :-----------: | :------------: | :--------: | :------------------: |
| 333 222 111    | 16.43%        | 50%            | 1.5%       | 0.12%                |
| 333 222 11     | 15.54%        | 48%            | 1.5%       | 0.11%                |
| 333 222 1      | 14.67%        | 46%            | 1.5%       | 0.10%                |
| 333            | 8.50%         | 32%            | 1.5%       | 0.04%                |
| 不装备         | 1.49%         | 14%            | 1.5%       | 0.003%               |


# 掉落判定步骤

武器掉落分四步：WeaponID -> WeaponLevel -> Slots -> TAG
- WeaponID: 判定掉落哪种武器（M92F/Python/...）
- WeaponLevel: 判定武器等级（Lv48, Lv49, Lv50, Lv51=蓝底)
- Slots: 判定孔数
- TAG：武器标签（无标签;各种标签;异名也是标签）

# 掉落判定第一步：Weapon ID

先决定掉落哪种武器。注意：异名是一个武器标签(TAG)，不是新的武器ID。

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_id = choose_weapon(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后从上到下查表获得武器ID。
武器表在ROM文件：archive\game\coop_table\weaponRate.lvt 中，原始内容为：

| Weapon Name | Weapon ID  | Rate% |
| :---------- | :--------- | :---- |
| M92F        | 0x80051000 | 8.0   |
| Government  | 0x80051010 | 7.5   |
| G18         | 0x80051040 | 2.0   |
| PC365       | 0x80051060 | 7.0   |
| Python      | 0x80051100 | 5.0   |
| L.Hawk      | 0x80051110 | 3.0   |
| Pale Rider  | 0x80051120 | 1.5   |
| MP5         | 0x80051200 | 7.5   |
| P-90        | 0x80051210 | 6.0   |
| AUG         | 0x80051220 | 7.0   |
| G36         | 0x80051230 | 7.5   |
| High Roller | 0x80051250 | 2.0   |
| Windham     | 0x80051300 | 8.0   |
| M3          | 0x80051310 | 7.5   |
| Hydra       | 0x80051320 | 2.0   |
| Drake       | 0x80051330 | 1.5   |
| M40A1       | 0x80051400 | 8.0   |
| PSG1        | 0x80051410 | 7.5   |
| Muramasa    | 0x80051420 | 1.5   |

以上表格中几率加在一起是100%，查表就是看分数落在那个区间中。举例：
- Score=1.0 查表判定 0x80051000 M92F
- Score=25.0 查表判定 0x80051100 Python
- Score=30.0 查表判定 0x80051110 L.Hawk
- Score=99.0 查表判定 0x80051420 村正

唯一的变数就是随机值 score 分数，即只要确定了 Score 值，那么就确定了武器ID，没有任何其他影响因素。

# 掉落判定第二步，Weapon Level

Weapon Level 判定武器等级（Lv48 / Lv49 / Lv50 / Lv51=蓝底)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_level(score, rare_finders)
```

解释：**品质分** -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后根据品质计算武器等级。
原始数据表在ROM文件archive\game\coop_table\weaponRarityRate.lvt

| Weapon Level | Rate   |
|-------|--------|
| +0    | 0.8221 |
| +1    | 0.1084 |
| +2    | 0.0546 |
| +3    | 0.0149 |

weapon_level指相对于关卡武器基数的增加等级 (+0 ~ +3)，混沌鬼船(GSC)武器基数Lv48, 因此混沌武器掉落Lv48~Lv51，其中Lv51=蓝底，从表格上看Lv51需要+3几率只有 0.0149(1.49%)，实际蓝底概率没这么低，这是因为装了寻宝插件(RareFinders)，它会对蓝底概率产生巨大的提升。

箱子开出蓝底Lv51所需的品质分：

| 寻宝数| 蓝底品质分 | 备注      |
|------|--------| -------- | 
| 9    | >=83.57| 装满各种寻宝 |
| 8    | >=84.46| 去掉1个 寻宝+ |
| 7    | >=85.33| 去掉2个 寻宝+ |
| 3    | >=91.50| 只留三个 寻宝+++ |
| 0    | >=98.51| 无寻宝，基础蓝底概率 1.49%|

RareFinders 分为三种： + ++ +++ ，可叠加，不区分顺序，每种分别增加1、2、3点数。例如三把武器装满寻宝，那么寻宝值(RF) = (1+2+3)*3 = 18点
以上计算每1点寻宝值可以增加Lv51概率0.83%

总结：蓝底纯粹基于随机数+寻宝插件计算判定。

# 掉落判定第三步、SLOT 孔数


伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_slots(score, weapon_id, weapon_level, rare_finders)
```

解释：品质分 -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后根据武器ID、是否蓝底、寻宝插件计算孔数。

孔数概率表在ROM文件archive\game\coop_table\weaponSlotRate.lvt 的最后一行
| -2   | -1   | +0   | +1   | +2   |
|------|------|------|------|------|
| 0.09 | 0.22 | 0.41 | 0.14 | 0.14 |

蓝底必+1孔，实际孔数 = 1 + 武器基础孔数 + 随机调整(-2 ~ +2)。游戏判定：根据品质分，看落到哪个档次(-2 ~ +2)，当然品质分太低会进入负数这档，意思是比标准的还要少孔。对于麦林来说不区分具体是哪把武器，因为Hawk虽然比Python基础孔数少1，但上下浮动算法一样。

上述表格为没有任何寻宝插件时的基础孔率，如果装了寻宝插件，会极大的影响满孔概率。每一点RF值增加2%概率。即：
```
满孔最低分数线 >= 100 - 基数14 - RF点数*2
```

下表为蓝底麦林满孔表（含Python/Hawk/PaleRider），意思是品质分多少以上，才能是满孔。


| 寻宝数| 满孔品质分| 备注      |
|------|-------| -------- | 
| 9    | >=50| 装满寻宝 |
| 8    | >=52| 去掉1个 寻宝+ |
| 7    | >=54| 去掉2个 寻宝+ |
| 3    | >=68| 只留三个 寻宝+++ |
| 0    | >=86| 无寻宝|

# 掉落判定第四步、TAG 标签

最后一步判定标签。注意：异名是一个武器标签(TAG)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int tag = choose_tag(score)
```
代码解释：品质分，即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得武器标签。只要这个数字确定，武器标签就确定。
标签表在ROM文件：archive\game\coop_table\weaponTagRate.lvt 中，原始内容为：

| 英文名         | 中文名      | TAG Id     | Rate% |
| :------------- | :---------- | :--------- | :---- |
| No TAG         | 无标签      | 0          | 50.0  |
| Short Range    | 短射程      | 0x80090000 | 5.0   |
| Long Range     | 长射程      | 0x80090001 | 5.0   |
| Easy Grip      | 轻松握力    | 0x80090002 | 5.0   |
| Speed Shot     | 高速射击    | 0x80090003 | 5.0   |
| Steady Hand    | 稳定之手    | 0x80090004 | 5.0   |
| Speed Load     | 高速装填    | 0x80090005 | 5.0   |
| Sonic Assist   | 音速助攻    | 0x80090006 | 5.0   |
| Light Weight   | 轻盈        | 0x80090007 | 6.0   |
| Sonic Assist+  | 音速助攻+   | 0x80090008 | 2.5   |
| Short Range+   | 短射程+     | 0x80090009 | 2.5   |
| Long Range+    | 长射程+     | 0x8009000A | 2.5   |
| Rare           | 异名        | 0x8009000B | 1.5   |

品质分 举例：
- 1.0 无标签
- 49.9  无标签
- 50.0 0x80090000 短射程
- 90.0 0x80090007 轻盈
- 98.4 0x8009000A 长射程+
- 98.5 0x8009000B 异名（Rare）
- 99.0 0x8009000B 异名（Rare）
- 99.9 0x8009000B 异名（Rare）

解释：无标签为 50%，异名（Rare）为1.5%，只有品质分超过98.5分才是异名

# 随机数可以控制吗
极难，因为随机数发生器（RNG）是游戏全局公用，状态由4个32位整数组成：4 × 32 = 128位状态空间，理论最大周期：2¹²⁸ - 1。不光武器掉落判定，敌人行动攻击，甚至游戏背景渲染等大量细节都会不停的使用随机数，因此预测下一步的值极为困难。
