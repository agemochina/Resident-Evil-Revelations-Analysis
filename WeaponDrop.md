# ResidentEvil:Revelations 生化危机启示录 武器掉落分析
分析的依据
- IDA 游戏代码的汇编GDB调试
- ROM 文件数据解析

PS：从反汇编代码看到叫这个： gacha ガチャ （看上去Capcom对抽卡这事已经下定论了）

# GSC武器掉落分析

为了简化起见，下面只写 GSC（混沌鬼船/Ghost Ship Chaos)的武器掉落。

武器掉落分四步：WeaponID -> WeaponLevel -> Slots -> TAG
- WeaponID: 先判定掉落哪种武器，注意：异名是标签不是武器类型。
- WeaponLevel: 判定武器等级（lv48, lv49, lv50, lv51=SP=蓝底)
- Slots: 判定孔数
- TAG：武器标签（无标签、各种标签、异名也是标签）

# 第一步：Weapon ID

先决定掉落哪种武器（M92F/PC365/.../Python/.../MP5/.../）。
注意：异名是一个武器标签(TAG)，不是新的武器ID。

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_id = choose_weapon(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得武器ID。武器表在ROM文件：archive\game\coop_table\weaponRate.lvt 中，原始内容为：

| weapon Id  | Rate |
|------------|------|
| 0x80051000 | 8.0  |
| 0x80051010 | 7.5  |
| 0x80051040 | 2.0  |
| 0x80051060 | 7.0  |
| 0x80051100 | 5.0  |
| 0x80051110 | 3.0  |
| 0x80051120 | 1.5  |
| 0x80051200 | 7.5  |
| 0x80051210 | 6.0  |
| 0x80051220 | 7.0  |
| 0x80051230 | 7.5  |
| 0x80051250 | 2.0  |
| 0x80051300 | 8.0  |
| 0x80051310 | 7.5  |
| 0x80051320 | 2.0  |
| 0x80051330 | 1.5  |
| 0x80051400 | 8.0  |
| 0x80051410 | 7.5  |
| 0x80051420 | 1.5  |


唯一的变数就是随机值 score，即只要确定了 Score 值，那么就确定了武器ID，没有任何其他影响因素。

举例：
```
Score=25.0 -> 0x80051100 Python
Score=30.0 -> 0x80051110 L.Hawk
```

# 第二步，Weapon Level

Weapon Level 判定武器等级（lv48, lv49, lv50, lv51=SP=蓝底)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_level(score, user_equipment)
```

解释：意思是先打分 -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得获得level。Level表在ROM文件archive\game\coop_table\weaponRarityRate.lvt

| Level | Rate |
|-------|------|
| +0    | 0.8221 |
| +1    | 0.1084 |
| +2    | 0.0546 |
| +3    | 0.0149 |

weapon_level指相对于基数的额外增加等级 [+0 ~ +3]，混沌鬼船(GSC)武器基数Lv48, 因此混沌武器掉落Lv48~Lv51，其中Lv51=蓝底(SP)

从表格上看，Lv51需要+3，几率只有 0.0149 即 1.49%，实际上SP蓝底概率远远那么低，因为你实际可以装备寻宝插件(Rare Finders)产生巨大的影响。

RareFinders 分为三种： + ++ +++ ，可叠加，不区分顺序，每种分别增加1、2、3点数。例如三把武器装满寻宝，那么寻宝值=(1+2+3)*3=18点。

每1点寻宝值可以增加Lv51掉率接近1%（实际上是0.82左右）

所以每个箱子开出LV51=SP蓝底几率为：
- 9RF（满寻宝值）时，SP掉率 = 1.49%(基数) + 18*0.83 ≈ 16.4%
- 8RF时，SP掉率 = 1.49%(基数) + 17*0.83 ≈ 15.5%
- 7RF时，SP掉率 = 1.49%(基数) + 16*0.83 ≈ 14.6%

（注意，上面8、7都是指拿掉最小的那个，所以减了1点影响不大）
