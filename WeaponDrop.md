# ResidentEvil:Revelations 生化危机启示录 GSC(混沌鬼船) 武器掉落分析

为了简化起见，下面只写 GSC（混沌鬼船/Ghost Ship Chaos)的武器掉落。

分析的依据
- IDA 游戏代码的汇编GDB调试
- ROM 文件数据解析

PS：从反汇编代码看到叫这个： gacha ガチャ （看上去Capcom对抽卡开奖的定位很清楚）


# 结论

太长不看版：先说结论。后文是详细分析报告。

- 武器掉落判定在结算界面，即初始化和拾取都不进行判定，只有结算的时候逐个开奖。
- 武器掉落和各种玄学因素无关（时间、杀敌数、受伤、9武器还是7武器、全船还是速刷、A还是B、物品栏），上述玄学因素不在掉落计算代码中，掉落计算只受随机数控制
- 寻宝插件(Rare Finders/人品插件)非常有用，会对蓝底率、满孔率产生巨大的影响。
- 想刷到好东西，正确方法带好寻宝插件，拼箱子数，弄其他玄学都没用。箱子开的越多理论上开出好东西概率越高。

常见概率（开1个箱子）
- 带9寻宝，蓝底 = 16.4%
- 带8寻宝，蓝底 = 15.5%
- 带7寻宝，蓝底 = 14.6%
- 带9寻宝，蓝底+异名 = 16.4% * 1.5% ≈ 0.246% 约等于千分之2.5
- 带9寻宝，蓝底+异名+满孔 = 16.4% * 1.5% * 40%  ≈ 0.1% 约等于千分之1
- 带9寻宝，蓝底+异名+各种麦林 = 16.4% * 1.5% * (5%+4%+1.5%) ≈ 0.01% 约等于万分之1
- 带9寻宝，蓝底+异名+满孔+各种麦林 = 16.4% * 1.5% * 40% * (5%+4%+1.5%) ≈ 0.01% 约等于万分之1

换句话说：
- 寻宝插件去掉一两个+区别不明显，但尽量不要去掉 +++ ++ 高级寻宝插件，有条件尽量多带
- 带7、8、9个寻宝插件
    - 跑7武器平均每局蓝底1.1个，跑9武器平均每局蓝底1.4个（不是说必出，是指大数据统计）
    - 平均开1000个箱子，能出1个蓝底满孔异名
    - 平均开10000个箱子，能出1个蓝底满孔异名麦林（魔蛇/雷霆之鹰/死神其中之一）

# 掉落判定步骤

武器掉落分四步：WeaponID -> WeaponLevel -> Slots -> TAG
- WeaponID: 先判定掉落哪种武器，注意：异名(RareTag)是标签不是武器类型。
- WeaponLevel: 判定武器等级（lv48, lv49, lv50, lv51=SP=蓝底)
- Slots: 判定孔数
- TAG：武器标签（无标签;各种标签;异名也是标签）

# 掉落判定第一步：Weapon ID

先决定掉落哪种武器（M92F/PC365/.../Python/.../MP5/.../）。
注意：异名是一个武器标签(TAG)，不是新的武器ID。

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_id = choose_weapon(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后从上到下查表获得武器ID。
武器表在ROM文件：archive\game\coop_table\weaponRate.lvt 中，原始内容为：

| weapon Id  | Rate |
|------------|------|
| 0x80051000 | 8.0  |
| 0x80051010 | 7.5  |
| 0x80051040 | 2.0  |
| 0x80051060 | 7.0  |
| 0x80051100 | 5.0  |
| 0x80051110 | 3.0  |
| 0x80051120 | 1.5  |
| 0x80051200 | 7.5  |
| 0x80051210 | 6.0  |
| 0x80051220 | 7.0  |
| 0x80051230 | 7.5  |
| 0x80051250 | 2.0  |
| 0x80051300 | 8.0  |
| 0x80051310 | 7.5  |
| 0x80051320 | 2.0  |
| 0x80051330 | 1.5  |
| 0x80051400 | 8.0  |
| 0x80051410 | 7.5  |
| 0x80051420 | 1.5  |


唯一的变数就是随机值 score，即只要确定了 Score 值，那么就确定了武器ID，没有任何其他影响因素。

以上表格中几率加在一起是100%，查表就是看分数落在那个区间中。分数举例：
- Score=1.0 查表判定 0x80051000 M92F
- Score=25.0 查表判定 0x80051100 Python
- Score=30.0 查表判定 0x80051110 L.Hawk
- Score=99.0 查表判定 0x80051420 村正


# 掉落判定第二步，Weapon Level

Weapon Level 判定武器等级（lv48, lv49, lv50, lv51=SP=蓝底)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int weapon_level = choose_level(score, user_equipment)
```

解释：意思是先打分 -- 即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得获得level。Level表在ROM文件archive\game\coop_table\weaponRarityRate.lvt

| Level | Rate |
|-------|------|
| +0    | 0.8221 |
| +1    | 0.1084 |
| +2    | 0.0546 |
| +3    | 0.0149 |

weapon_level指相对于基数的额外增加等级 [+0 ~ +3]，混沌鬼船(GSC)武器基数Lv48, 因此混沌武器掉落Lv48~Lv51，其中Lv51=蓝底(SP)，从表格上看Lv51需要+3才行几率只有 0.0149(1.49%)，实际游戏体验SP蓝底概率远远那么低，因为你实际装了寻宝插件(Rare Finders/人品插件)，它会对蓝底几率产生巨大的影响。

RareFinders 分为三种： + ++ +++ ，可叠加，不区分顺序，每种分别增加1、2、3点数。例如三把武器装满寻宝，那么寻宝值=(1+2+3)*3=18点。

每1点寻宝值可以增加Lv51掉率接近1%（实际≈0.82%）

所以每个箱子开出LV51=SP蓝底几率为：
- 9RF，SP率 = 1.49%(基数) + 18*0.83 ≈ 16.4%
- 8RF，SP率 = 1.49%(基数) + 17*0.83 ≈ 15.5%
- 7RF，SP率 = 1.49%(基数) + 16*0.83 ≈ 14.6%
- 3RF(+++ +++ +++)，SP率 = 1.49%(基数) + 9*0.83 ≈ 8.8%
- 0RF，SP率 = 1.49%

（注意，上面8、7都是指拿掉最小的那个+，影响不太大）

# 掉落判定第三步、SLOT

# 掉落判定第四步、TAG 标签

最后一步判定标签。注意：异名是一个武器标签(TAG)

伪代码：
```C++
    float score = rand_float_n(100.0)
    int tag = choose_tag(score)
```
代码解释：先打分，即随机产生一个 [0.0, 100.0) 之间的小数，然后查表获得武器标签。只要这个数字确定，武器标签就确定。
标签表在ROM文件：archive\game\coop_table\weaponTagRate.lvt 中，原始内容为：

| TAG        | Rate |
| :--------- | :--- |
| 0（无标签） | 50.0 |
| 0x80090000 | 5.0  |
| 0x80090001 | 5.0  |
| 0x80090002 | 5.0  |
| 0x80090003 | 5.0  |
| 0x80090004 | 5.0  |
| 0x80090005 | 5.0  |
| 0x80090006 | 5.0  |
| 0x80090007 | 6.0  |
| 0x80090008 | 2.5  |
| 0x80090009 | 2.5  |
| 0x8009000A | 2.5  |
| 0x8009000B | 1.5  |

举几个score值例子：
- 1.0 无
- 49.9  无
- 50.0 0x80090000 短射程
- 90.0 0x80090007 轻盈
- 98.4 0x8009000A 长射程+
- 98.5 0x8009000B 异名
- 99.0 0x8009000B 异名
- 99.9 0x8009000B 异名

解释：无标签为 50%，异名RareTag（0x8009000B） 为1.5%，只有随机分超过98.5分才是异名
